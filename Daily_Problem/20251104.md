# [3321. 计算子数组的 x-sum II](https://leetcode.cn/problems/find-x-sum-of-all-k-long-subarrays-ii/)

## 解题思路

1. 维护长度为$k$的区间

2. 利用两个$set$, 其中一个维护前$x$大的数,另一个维护长度为$k$的区间剩下的数. 

   **注:**两个$set$都维护数的出现次数以及对应的数(利用pair<int, int>)

## 参考代码


```cpp
\\ 时间复杂度O(nlogn)
using i64 = long long;
using pii = pair<int, int>;
class Solution {
public:
    vector<long long> findXSum(vector<int>& nums, int k, int x) {
        int n = nums.size();
        i64 sum = 0;
        map<int, int> cnt;
        vector<i64> ans(n - k + 1);
        set<pii> st0, st1;
        for (int i = 0, j = 0; i < n; ++i) {
            int new_cnt = cnt[nums[i]] + 1, old_cnt = cnt[nums[i]];
            cnt[nums[i]] = new_cnt;

            st0.erase({old_cnt, nums[i]});
            st1.erase({old_cnt, nums[i]});
            st0.insert({new_cnt, nums[i]});

            if (st0.size() <= x) {
                sum += nums[i];
            } else {
                if (make_pair(new_cnt, nums[i]) != *st0.begin()) {
                    sum = sum - 1LL * st0.begin()->first * st0.begin()->second + 1LL * new_cnt * nums[i];
                }
                st1.insert(*st0.begin());
                st0.erase(st0.begin());
            }

            if (i - j + 1 == k) {
                ans[j] = sum;
                int old_cnt1 = cnt[nums[j]], new_cnt1 = cnt[nums[j]] - 1;
                cnt[nums[j]] = new_cnt1;
                if (st1.count({old_cnt1, nums[j]})) {
                    st1.erase({old_cnt1, nums[j]});
                    if (new_cnt1 > 0) {
                        st1.insert({new_cnt1, nums[j]});
                    }
                } else {
                    st0.erase({old_cnt1, nums[j]});
                    st0.insert({new_cnt1, nums[j]});
                    if (!st1.empty() && *prev(st1.end()) > *st0.begin()) {
                        auto it = prev(st1.end());
                        pii end = *it;
                        sum = sum - 1LL * old_cnt1 * nums[j] + 1LL * end.first * end.second;
                        if (new_cnt1 > 0) {
                            st1.insert(*st0.begin());
                        }
                        st0.insert(end);
                        st0.erase(st0.begin());
                        st1.erase(it);
                    } else {
                        sum -= nums[j];
                    }
                }
                ++j;
            }
        }
        return ans;
    }
};

```

